/*
 client 2016-02-22 
*/
"use strict";var chatApp=angular.module("chatApp",["ngRoute","ui.bootstrap"]).config(["$routeProvider",function(a){a.when("/",{templateUrl:"/src/login/login.html",controller:"LoginController"}).when("/rooms/:user",{templateUrl:"/src/roomlist/roomlist.html",controller:"RoomlistController"}).when("/rooms/:user/:id",{templateUrl:"/src/room/room.html",controller:"RoomController"}).when("/createroom/:user",{templateUrl:"/src/newroom/createroom.html",controller:"CreateRoomController"})}]);chatApp.value("LoggedIn");var checkAuthOfUser=function(a,b,c){console.log("Loggedin_cjel: ",b);var d=a.defer();return void 0===b?(d.reject(),c.path("/")):d.resolve(!0),d.promise};chatApp.factory("socket",function(a){var b=io.connect("http://localhost:8333");return{on:function(c,d){b.on(c,function(){var c=arguments;a.$apply(function(){d.apply(b,c)})})},emit:function(c,d,e){b.emit(c,d,function(){var c=arguments;a.$apply(function(){e&&e.apply(b,c)})})}}}),chatApp.controller("LoginController",["$scope","$location","socket","LoggedIn","$timeout",function(a,b,c,d,e){console.log("Loggedin:",d),a.user="",a.errorMessage="",a.taken="",a.showError=!1,a.doFade=!1,a.onLogin=function(f){d=a.user,a.showError=!1,a.doFade=!1,a.showError=!0,a.errorMessage="You have to put some name in the field",""===a.user?e(function(){a.doFade=!0},2500):c.emit("adduser",a.user,function(c,d){c?b.path("rooms/"+a.user):(a.errorMessage="This User is already taken choose another one !",e(function(){a.doFade=!0},2500))})}}]),chatApp.controller("navBarController",["$scope","$location","socket","$routeParams",function(a,b,c,d){a.logOutServer=function(){c.emit("dis",d.user),console.log("logOutServer"+d.user),b.path("/")},a.homeButton=function(){console.log("HOMEBUTTON"),b.path("/rooms/"+d.user)}}]),chatApp.controller("RoomlistController",["$scope","$location","socket","$routeParams","$timeout",function(a,b,c,d,e){var f="";c.emit("users");var g="",h="";a.enteredPassword="",a.showError=!1,a.doFade=!1,c.on("userlist",function(b){a.users=b}),c.emit("rooms"),a.roomlist=[],a.user=d.user,a.chosenRoom=function(a){g=a},a.joinRoom=function(){var d=g,i=[];i.push(f),console.log(i);var j=i.map(_.property(g));h=0!==j[0]?{room:g,pass:a.enteredPassword}:{room:g,pass:""},c.emit("joinroom",h,function(c,f){c?(console.log("sucessfully joined a room"),b.path("rooms/"+a.user+"/"+d)):(a.showError=!1,a.doFade=!1,a.showError=!0,"banned"===f?(a.errorMessage="you are banned from the room",e(function(){a.doFade=!0},2500)):"wrong password"===f&&(a.errorMessage="wrong password",e(function(){a.doFade=!0},2500)),console.log("could not connect"))})},a.createNewRoom=function(){b.path("createroom/"+a.user)};var i=function(b){console.log("-----------------------------"),console.log(b),f=_.mapValues(b,"password"),console.log("A: ",f),a.roomlist=b,a.roomname=_.keys(b),console.log(a.roomname)};c.on("roomlist",i)}]),chatApp.controller("CreateRoomController",["$scope","$routeParams","socket","$window","$location","$timeout",function(a,b,c,d,e,f){a.newRoomName="",a.newRoomPassword="",a.newTopic="",a.user=b.user,a.showError=!1,a.doFade=!1,c.emit("rooms");var g="";c.on("roomlist",function(a){console.log("rooms ",_.keys(a)),g=_.keys(a)}),a.create=function(){a.showError=!1,a.doFade=!1,a.showError=!0;var b=$.inArray(a.newRoomName,g);if(""===a.newRoomName)a.errorMessage="You have to put in some name of the room!!",f(function(){a.doFade=!0},2500);else if(-1!==b)a.errorMessage="There is room already named that!!",f(function(){a.doFade=!0},2500);else{var d={room:a.newRoomName,pass:a.newRoomPassword};c.emit("joinroom",d,function(b,d){if(b){if(""!==a.newRoomPassword){var g={room:a.newRoomName,password:a.newRoomPassword};c.emit("setpassword",g,function(b){b&&(a.newRoomPassword="")})}if(""!==a.newTopic){var h={room:a.newRoomName,topic:a.newTopic};c.emit("settopic",h,function(b){b&&(a.newTopic="")})}e.path("/rooms/"+a.user+"/"+a.newRoomName)}else a.errorMessage="Something went wrong!!",f(function(){a.doFade=!0},2500)})}}}]),chatApp.controller("RoomController",["$scope","$routeParams","socket","$location","$timeout",function(a,b,c,d,e){var f=b.user;a.roomname=b.id;var g=a.roomname;a.isAdmin=!1,a.displaySuccess=!1,a.adminsInRoom="",a.glued=!0,a.show=!1,a.unbanshow=!1;var h="";a.roomPassword="";var i=1,j=1;a.isPrv=!1;var k="";a.GetPrv=!1;var l="",m=[];a.showError=!1,a.doFade=!1;var n={room:g};c.emit("hasjoined",n),c.on("updatechat",function(b,c){b===g&&(a.messageInRoom=c)}),c.on("updateusers",function(b,c,d){b===g&&(a.userlist=_.keys(c),a.adminsInRoom=d,d[f]===f?(a.isAdmin=!0,console.log(f," is Admin in this room")):(a.isAdmin=!1,console.log(f," is NOT Admin in this room")))}),c.on("kicked",function(c,h,i){b.user===h&&c===g&&b.user!==i&&(a.sucessMessage="You have been kicked from the room!",a.showError=!1,a.doFade=!1,a.showError=!0,e(function(){a.doFade=!0,d.path("rooms/"+f)},2500))}),c.on("banned",function(c,h,i){b.user===h&&c===g&&b.user!==i&&(a.sucessMessage="You have been banned from the room!",a.showError=!1,a.doFade=!1,a.showError=!0,e(function(){a.doFade=!0,d.path("rooms/"+f)},2500))}),c.on("servermessage",function(b,c,d){c==g&&("part"==b&&(l=d+" has left "+c),"quit"==b&&(l=d+" has disconnected"),"join"==b&&(l=d+" has joined "+c),"kick"==b&&(l=d+" has been kicked from "+c),"op"==b&&(l=d+" has been made op of "+c),"deop"==b&&(l=d+" is no longer op "+c),"ban"==b&&(l=d+" has been banned from "+c),"unban"==b&&(l=d+" has been unbanned from "+c),a.ServMessage=l)}),c.on("updatetopic",function(b,c,d){a.topic=c,console.log("UpdateTopic"),console.log("Room: ",b),console.log("Topic: ",c),console.log("User: ",d)}),a.$on("$destroy",function(){console.log("destroy og roomname er: ",a.roomname)}),a.sendMessage=function(){if(""===a.newmessage);else{console.log("sendMessage");var b={msg:a.newmessage,roomName:g};c.emit("sendmsg",b),a.newmessage=""}},a.roomSettings=function(){i++,i%2===0?a.show=!0:a.show=!1},c.on("recv_privatemsg",function(b,c){a.GetPrv=!0,a.recvMessage=c,a.fromUser=b,console.log("RECIVEDMESSAGE",c)}),a.dismiss=function(){a.GetPrv=!1},a.privateMessage=function(b){a.GetPrv=!1,a.recvUser=b,console.log(b+"   Senda private"),b==f||(console.log("inní drasli"),a.isPrv=!0,a.sendPrvMessage=function(){if(k=a.privmessage,""===k)console.log("auttt");else{console.log("hello");var d={nick:b,message:k};console.log(d),c.emit("privatemsg",d),a.isPrv=!1}})},a.kickUser=function(b){if(b===f);else{var d={user:b,room:a.roomname};console.log("kickobj: v"),console.log(d.user),c.emit("kick",d,function(a){a&&console.log(b," was kicked!!")})}},a.banUser=function(a){if(a===f);else{var b={user:a,room:g};m.push(b),console.log("Banned list: ",m),c.emit("ban",b,function(b){b&&console.log(a," was banned!!")})}},a.opUser=function(a){var b={user:a,room:g};c.emit("op",b,function(b){b&&console.log(a," was opped!!")})},a.unban=function(){console.log("Unbannn"),j++,j%2===0?a.unbanshow=!0:a.unbanshow=!1;for(var b=[],c=0;c<m.length;c++)m[c].room==g&&b.push(m[c].user);a.bannedUserList=b,console.log("User list yfir banned user í þessu roomi : ",b)},a.unbanUser=function(a){for(var b={user:a,room:g},d=0;d<m.length;d++)m[d].user===a&&m[d].room===g&&m.splice(d,1);console.log("Hvað er eftir í bannedList",m),c.emit("unban",b,function(b){b&&console.log(a,"was unbanned")})},a.deopUser=function(a){var b={user:a,room:g};c.emit("deop",b)},a.leaveRoom=function(){c.emit("partroom",g),d.path("rooms/"+f)},a.submit=function(){if(console.log("Topic: ",h),console.log("Password: ",a.roomPassword),h=a.newTopic,""===h)console.log("roomtopic has to have string");else{var b={room:g,topic:h};c.emit("settopic",b,function(a){a?(console.log("Successfully changed topic"),h=""):console.log("Unsuccessfully changed topic")})}if(""===a.roomPassword)console.log("password is empty");else{var d={room:g,password:a.roomPassword};console.log("PASSWORD OBJECT"),console.log(d),c.emit("setpassword",d,function(b){b?(console.log("Successfully changed password"),a.roomPassword=""):console.log("Unsuccessfully changed password")})}},a.removePassword=function(){var a={room:g};c.emit("removepassword",a,function(a){a?console.log("Successfully removed password"):console.log("Unsuccessfully removed password")})}}]);